
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>checkboxでAjaxで更新（PATCH）処理</title>
    
    <meta name="author" content="happyclam">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.2.2.2.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
<!-- mathjax config similar to math.stackexchange -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-1752720-7', 'happyclam.github.io');
      ga('send', 'pageview');
    </script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">自己満足プログラミング</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- bigbanner -->
<ins class="adsbygoogle"
     style="display:inline-block;width:728px;height:90px"
     data-ad-client="ca-pub-1238485061299241"
     data-ad-slot="7896368612"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    <div class="container-narrow">

      <div class="content">
        
<div class="page-header">
  <h1>checkboxでAjaxで更新（PATCH）処理 </h1>
</div>

<div class="row-fluid post-full">
  <div class="span12">
    <div class="date">
      <span>26 December 2014</span>
    </div>
    <div class="content">
      <h3 id="jqueryajaxcoffeescript">jQuery,Ajax,CoffeeScript覚えること多過ぎ</h3>
<p>　<a href="http://my-posi.herokuapp.com/">先物・オプションのシミュレーションサイト</a>のポジション編集画面で、チェックボックスをクリックすることでグラフのタイプを切り替える処理（データ更新後リダイレクトしている）をしているのですが、これをAjaxで実現しようとしたところ思わぬエラーに遭遇したので、新規サンプルプロジェクトを作って改めて動作を確認することにしました。</p>

<pre><code>rails _4.1.6_ new chkbox                ←バージョンを指定して新規プロジェクト作成
cd chkbox
rails g scaffold memo body:string chk:boolean
bundle install
rake db:migrate
rails s
</code></pre>

<div style="width:320px; margin: 0 auto;">

  <p><a href="/images/scaffold_edit.png" target="_blank"><img src="/images/scaffold_edit.png" alt="scaffold 編集画面" title="scaffold 編集画面" /></a></p>

</div>

<p>　あと、turbolinksを有効にしているとAjaxの動作状況が分かりにくいので<a href="http://qiita.com/kazz187/items/12737363d62b9c91993c">このサイト</a>を参考にしてturbolinksを無効にしました。</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#777">#app/views/memos/_form.html.erb</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span> &lt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%=</span><span style="color:#D20"> form_for(@memo, remote: true) do |f| %&gt;</span></span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">   &lt;div class</span><span style="color:#710">=</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">field</span><span style="color:#710">&quot;</span></span>&gt;
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>     &lt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%=</span><span style="color:#D20"> f.label :body %&gt;&lt;br&gt;</span></span>
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">     &lt;%</span><span style="color:#710">=</span></span> f.text_field <span style="color:#A60">:body</span> %&gt;
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>   &lt;<span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">div&gt;</span></span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">   &lt;div class=&quot;field&quot;&gt;</span></span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">     &lt;%= f.label :chk %&gt;&lt;br&gt;</span></span>
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">     &lt;%= f.check_box :chk %&gt;</span></span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">   &lt;</span><span style="color:#404">/</span></span>div&gt;
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>   &lt;div <span style="color:#080;font-weight:bold">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">actions</span><span style="color:#710">&quot;</span></span>&gt;
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>     &lt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%=</span><span style="color:#D20"> f.submit %&gt;</span></span>
<span class="line-numbers"><a href="#n13" name="n13">13</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">   &lt;/div&gt;</span></span>
<span class="line-numbers"><a href="#n14" name="n14">14</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">   &lt;div id</span><span style="color:#710">=</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">status</span><span style="color:#710">&quot;</span></span>&gt;&lt;<span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">div&gt;</span></span>
<span class="line-numbers"><a href="#n15" name="n15">15</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808"> &lt;% end %&gt;</span></span>
<span class="line-numbers"><a href="#n16" name="n16">16</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808"></span></span></pre></div>
</div>
</div>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#777">#app/controllers/memos_controller.rb</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">update</span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>    <span style="color:#080;font-weight:bold">if</span> <span style="color:#33B">@memo</span>.update(memo_params)
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>      <span style="color:#33B">@status</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">O.K.</span><span style="color:#710">&quot;</span></span>
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>    <span style="color:#080;font-weight:bold">else</span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>      <span style="color:#33B">@status</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">N.G.</span><span style="color:#710">&quot;</span></span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>    <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>    render
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>  <span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#777">#app/views/memos/update.js.erb</span>
<span class="line-numbers"><a href="#n2" name="n2">2</a></span><span style="color:#F00;background-color:#FAA">$</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">#status</span><span style="color:#710">'</span></span>).html(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">&lt;%= j(@status) %&gt;</span><span style="color:#710">&quot;</span></span>);
</pre></div>
</div>
</div>

<p>　scaffoldで生成された状態からformに<code>remote: true</code>を追加してcontrollerをすこし弄ってupdate.js.erbを新規作成しただけですが、フォームのボタンをクリックするとAjax通信でデータの更新処理が完了し、コントローラから渡された文字列をビューに表示出来ます。フレームワークが用意してくれた仕組みを素直に使えば非常に簡単にAjax更新処理が実現できました。<br />
　そこで今度はフォームのsubmitボタンではなく、チェックボックスをクリックすることで同じことをやろうとしてフォームのcheck_boxの行を<code>&lt;%= f.check_box(:chk, {:onchange =&gt; "this.form.submit();"}, "t", "f") %&gt;</code>と書き換えて、チェックボックスをクリックするとInvalidAuthenticityTokenエラーが出ました。</p>

<div style="width:320px; margin: 0 auto;">

  <p><a href="/images/invalidauthenticitytoken.png" target="_blank"><img src="/images/invalidauthenticitytoken.png" alt="InvalidAuthenticityTokenエラー画面" title="InvalidAuthenticityTokenエラー画面" /></a></p>

</div>

<p>　javascriptでsubmitしてしまうとcsrf-tokenが送られないということでしょう。ユーザ認証（ログイン処理）していなくてもPOST（この場合PATCH）リクエストを送る場合は必要なのか？と思いながらフォーム内に<code> &lt;%= hidden_field_tag(:authenticity_token, form_authenticity_token) %&gt;</code>を記述して再度チェックボックスをクリックすると今度はTemplate is missingエラー。</p>

<div style="width:320px; margin: 0 auto;">

  <p><a href="/images/templatemissing.png" target="_blank"><img src="/images/templatemissing.png" alt="Template Missing エラー画面" title="Template Missing エラー画面" /></a></p>

</div>

<p>　フォームのPATH指定時にformatを指定してこのように<code>&lt;%= form_for(@memo, url: memo_path(@memo, format: :js), remote: true) do |f| %&gt;</code>書き換えて、再度チェックボックスをクリックすると、ブラウザにupdate.js.erbファイルの中身が文字として表示されました。  </p>

<div style="width:320px; margin: 0 auto;">

  <p><a href="/images/browser_disp.png" target="_blank"><img src="/images/browser_disp.png" alt="Text Response 画面" title="Text Response 画面" /></a></p>

</div>

<p>　ここまで来てもすぐには自分の間違いに気が付きませんでした。上でも自分で書いているけど、javascriptで普通にsubmitしているのだからAjax通信出来ていないようです。remote: true を書くことでフォームがAjax用になっているからform.submit()でAjax通信が出来るような錯覚をしていました。冒頭で思わぬエラーに遭遇したと書いたのはこのことです^^;<br />
　HTMLのソースを見てみるとフォームには<code>data-remote="true"</code>の属性が付加されていたので、onchangeでthis.form.submit()するのではなくjavascriptの関数を作ってその中で<code>form.setAttribute('data-remote', true);</code>とやってcheckboxに無理やり<code>data-remote="true"</code>の属性を付加してみましたが効果ありませんでした^^; Railsがどういう仕組みでAjaxを実現しているのかよくわかってませんが、Railsで予定していない使い方であることは確かなようです。 <br />
　で、form.submit()ではダメだとわかったので次のようにcheckboxのonchange=のイベントを削除して、jQueryでイベントを登録してそのイベント内でAjax通信するようにしました。Ajax送信後のCallback処理もそこに記述したのでjs.erbは使いません。<code>render :text =&gt; @status</code>とすれば.doneイベント（コールバック関数）のdata引数に@statusの内容が入って来るので。<code>$('#status').html(data);</code>として画面に表示します。これで一応UnobtrusiveなJavascriptというかHTMLとスクリプトの分離が出来たのは目出度いことです。<br />
　それと、先ほどエラー回避のためにフォーム内のPATHを変更しましたが、_form.html.erbはupdateのときだけでなくcreateのときも使用しているので元に戻しておきます。そうすればチェックボックスでの更新処理はあくまで追加の機能として作成できます。</p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#777">#app/views/memos/_form.html.erb</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>&lt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%=</span><span style="color:#D20"> javascript_tag do %&gt;</span></span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">jQuery(function ($){</span></span>
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">    $(&quot;#memo_chk&quot;).on('change', function(){</span></span>
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">        body </span><span style="color:#710">=</span></span> <span style="color:#F00;background-color:#FAA">$</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">#memo_body</span><span style="color:#710">&quot;</span></span>).val();
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>        authenticity_token = <span style="color:#F00;background-color:#FAA">$</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">#authenticity_token</span><span style="color:#710">&quot;</span></span>).val();
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>        <span style="color:#d70">$.</span>ajax({
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>            <span style="color:#606">url</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">&lt;%= memo_path(id: @memo.id, format: :js) %&gt;</span><span style="color:#710">'</span></span>,
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>            <span style="color:#606">type</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">PATCH</span><span style="color:#710">'</span></span>,
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>            <span style="color:#606">dataType</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">html</span><span style="color:#710">'</span></span>,
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>            <span style="color:#606">data</span>: {
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>                <span style="color:#606">id</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">&lt;%= @memo.id %&gt;</span><span style="color:#710">'</span></span>,
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>                <span style="color:#606">authenticity_token</span>: authenticity_token,
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>                <span style="color:#606">memo</span>: {
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>                    <span style="color:#606">body</span>: body,
<span class="line-numbers"><a href="#n16" name="n16">16</a></span>                    <span style="color:#606">chk</span>: (this.checked) ? <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">t</span><span style="color:#710">'</span></span> : <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">f</span><span style="color:#710">'</span></span>
<span class="line-numbers"><a href="#n17" name="n17">17</a></span>                    }
<span class="line-numbers"><a href="#n18" name="n18">18</a></span>            }
<span class="line-numbers"><a href="#n19" name="n19">19</a></span>        }).done(function(data, status, xhr) {
<span class="line-numbers"><strong><a href="#n20" name="n20">20</a></strong></span>            <span style="color:#F00;background-color:#FAA">$</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">#status</span><span style="color:#710">'</span></span>).html(data);
<span class="line-numbers"><a href="#n21" name="n21">21</a></span>        }).fail(function(xhr, status, error) {
<span class="line-numbers"><a href="#n22" name="n22">22</a></span>            alert(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Error Occured(</span><span style="color:#710">'</span></span> + error + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">)</span><span style="color:#710">'</span></span>);
<span class="line-numbers"><a href="#n23" name="n23">23</a></span>        });
<span class="line-numbers"><a href="#n24" name="n24">24</a></span>     });
<span class="line-numbers"><a href="#n25" name="n25">25</a></span>});
<span class="line-numbers"><a href="#n26" name="n26">26</a></span>&lt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">% </span><span style="color:#D20">end</span><span style="color:#710"> </span></span>%&gt;
<span class="line-numbers"><a href="#n27" name="n27">27</a></span>
<span class="line-numbers"><a href="#n28" name="n28">28</a></span>&lt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%=</span><span style="color:#D20"> form_for(@memo, remote: true, html:{name: &quot;frm_chkbox&quot;}) do |f| %&gt;</span></span>
<span class="line-numbers"><a href="#n29" name="n29">29</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">  &lt;%</span><span style="color:#710">=</span></span> hidden_field_tag(<span style="color:#A60">:authenticity_token</span>, form_authenticity_token) %&gt;
<span class="line-numbers"><strong><a href="#n30" name="n30">30</a></strong></span>  &lt;div <span style="color:#080;font-weight:bold">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">field</span><span style="color:#710">&quot;</span></span>&gt;
<span class="line-numbers"><a href="#n31" name="n31">31</a></span>    &lt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%=</span><span style="color:#D20"> f.label :body %&gt;&lt;br&gt;</span></span>
<span class="line-numbers"><a href="#n32" name="n32">32</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">    &lt;%</span><span style="color:#710">=</span></span> f.text_field <span style="color:#A60">:body</span> %&gt;
<span class="line-numbers"><a href="#n33" name="n33">33</a></span>  &lt;<span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">div&gt;</span></span>
<span class="line-numbers"><a href="#n34" name="n34">34</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">  &lt;div class=&quot;field&quot;&gt;</span></span>
<span class="line-numbers"><a href="#n35" name="n35">35</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">    &lt;%= f.label :chk %&gt;&lt;br&gt;</span></span>
<span class="line-numbers"><a href="#n36" name="n36">36</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">    &lt;%= f.check_box(:chk) %&gt;</span></span>
<span class="line-numbers"><a href="#n37" name="n37">37</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">  &lt;</span><span style="color:#404">/</span></span>div&gt;
<span class="line-numbers"><a href="#n38" name="n38">38</a></span>  &lt;div <span style="color:#080;font-weight:bold">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">actions</span><span style="color:#710">&quot;</span></span>&gt;
<span class="line-numbers"><a href="#n39" name="n39">39</a></span>    &lt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%=</span><span style="color:#D20"> f.submit %&gt;</span></span>
<span class="line-numbers"><strong><a href="#n40" name="n40">40</a></strong></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">  &lt;/div&gt;</span></span>
<span class="line-numbers"><a href="#n41" name="n41">41</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20"></span></span>
<span class="line-numbers"><a href="#n42" name="n42">42</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">  &lt;div id</span><span style="color:#710">=</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">status</span><span style="color:#710">&quot;</span></span>&gt;&lt;<span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">div&gt;</span></span>
<span class="line-numbers"><a href="#n43" name="n43">43</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">&lt;% end %&gt;</span></span>
<span class="line-numbers"><a href="#n44" name="n44">44</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808"></span></span></pre></div>
</div>
</div>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#777">#app/controllers/memos_controller.rb</span>
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  render <span style="color:#A60">:text</span> =&gt; <span style="color:#33B">@status</span>
</pre></div>
</div>
</div>

<p>　これで一応checkboxのクリック時は動くのですが、render部分を変更したために更新ボタンをクリックした場合に何も表示されません。はじめはcheckboxイベント用の別メソッドをコントローラに追加したのですが、更新処理自体は同じものなので既存のupdateメソッドをそのまま使って表示の際に分岐するようにします。<br />
　それからテンプレートとjavascriptは分けておこうと思ってjavascript部分をapp/asset/javascript/ディレクトリに別ファイル（chkbox.js）として移動したのですが、ajax呼び出し時のurl:パラメータが上手く展開されませんでした。拡張子に「erb」を追加すればRailsがちゃんと展開してくれるとどこかに書かれていたので.jsからerb.jsに拡張子を変えてみましたが上手くいきませんでした。<br />
　それとRails4から新規プロジェクトを作成すると勝手にコントローラ毎のjs.coffeeファイルが作られるので、どうせならそちらに移動しようと思いcoffeescriptに書き換えて<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>最終的には以下のようにしました。  </p>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span>#app/assets/javascripts/memos.js.coffee
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>jQuery ($) -&gt;
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>    $(&quot;#memo_chk&quot;).on &quot;change&quot;, -&gt;
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>        id = $(&quot;#memo_id&quot;).val()
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>        body = $(&quot;#memo_body&quot;).val()
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>        chk = $(this).is(&quot;:checked&quot;) ? &quot;t&quot; : &quot;f&quot;
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>        authenticity_token = $(&quot;#authenticity_token&quot;).val()
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>        $.ajax(
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>            url: &quot;/memos/&quot; + id + &quot;.js&quot;
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>            type: &quot;PATCH&quot;
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>            dataType: &quot;text&quot;
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>            data:
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>                id: id
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>                authenticity_token: authenticity_token
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>                memo:
<span class="line-numbers"><a href="#n16" name="n16">16</a></span>                    body: body
<span class="line-numbers"><a href="#n17" name="n17">17</a></span>                    chk: (if chk then &quot;t&quot; else &quot;f&quot;)
<span class="line-numbers"><a href="#n18" name="n18">18</a></span>        ).done((data, status, xhr) -&gt;
<span class="line-numbers"><a href="#n19" name="n19">19</a></span>            $(&quot;#status&quot;).html data
<span class="line-numbers"><strong><a href="#n20" name="n20">20</a></strong></span>            return
<span class="line-numbers"><a href="#n21" name="n21">21</a></span>        ).fail (xhr, status, error) -&gt;
<span class="line-numbers"><a href="#n22" name="n22">22</a></span>            alert &quot;Error Occured(&quot; + error + &quot;)&quot;
<span class="line-numbers"><a href="#n23" name="n23">23</a></span>            return
<span class="line-numbers"><a href="#n24" name="n24">24</a></span>
<span class="line-numbers"><a href="#n25" name="n25">25</a></span>        return
<span class="line-numbers"><a href="#n26" name="n26">26</a></span>
<span class="line-numbers"><a href="#n27" name="n27">27</a></span>    return
</pre></div>
</div>
</div>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#777">#app/views/memos/_form.html.erb</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>&lt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%=</span><span style="color:#D20"> form_for(@memo, remote: true, html:{name: &quot;frm_memo&quot;}) do |f| %&gt;↓</span></span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">  &lt;%</span><span style="color:#710">=</span></span> hidden_field_tag(<span style="color:#A60">:memo_id</span>, <span style="color:#33B">@memo</span>.id) %&gt;↓
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>  &lt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%=</span><span style="color:#D20"> hidden_field_tag(:authenticity_token, form_authenticity_token) %&gt;</span></span>
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">  &lt;div class</span><span style="color:#710">=</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">field</span><span style="color:#710">&quot;</span></span>&gt;↓
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>    &lt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%=</span><span style="color:#D20"> f.label :body %&gt;&lt;br&gt;↓</span></span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">    &lt;%</span><span style="color:#710">=</span></span> f.text_field <span style="color:#A60">:body</span> %↓
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>  &lt;<span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">div&gt;↓</span></span>
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">  &lt;div class=&quot;field&quot;&gt;↓</span></span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">    &lt;%= f.label :chk %&gt;&lt;br&gt;↓</span></span>
<span class="line-numbers"><a href="#n11" name="n11">11</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">    &lt;%= f.check_box(:chk) %&gt;↓</span></span>
<span class="line-numbers"><a href="#n12" name="n12">12</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">  &lt;</span><span style="color:#404">/</span></span>div&gt;↓
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>  &lt;div <span style="color:#080;font-weight:bold">class</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">actions</span><span style="color:#710">&quot;</span></span>&gt;↓
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>    &lt;<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%=</span><span style="color:#D20"> f.submit %&gt;↓</span></span>
<span class="line-numbers"><a href="#n15" name="n15">15</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">  &lt;/div&gt;↓</span></span>
<span class="line-numbers"><a href="#n16" name="n16">16</a></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">  &lt;div id</span><span style="color:#710">=</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">status</span><span style="color:#710">&quot;</span></span>&gt;&lt;<span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">div&gt;↓</span></span>
<span class="line-numbers"><a href="#n17" name="n17">17</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808">&lt;% end %&gt;↓</span></span>
<span class="line-numbers"><a href="#n18" name="n18">18</a></span><span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#808"></span></span></pre></div>
</div>
</div>

<div class="highlighter-coderay"><div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#777">#app/controllers/memos_controller.rb</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">update</span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>    <span style="color:#080;font-weight:bold">if</span> <span style="color:#33B">@memo</span>.update(memo_params)
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>      <span style="color:#33B">@status</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">O.K.</span><span style="color:#710">&quot;</span></span>
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>    <span style="color:#080;font-weight:bold">else</span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>      <span style="color:#33B">@status</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">N.G.</span><span style="color:#710">&quot;</span></span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>    <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>    <span style="color:#080;font-weight:bold">if</span> request.method == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">PATCH</span><span style="color:#710">&quot;</span></span>
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>      render <span style="color:#A60">:text</span> =&gt; <span style="color:#33B">@status</span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>    <span style="color:#080;font-weight:bold">else</span>
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>      render <span style="color:#606">template</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">memos/update.js.erb</span><span style="color:#710">&quot;</span></span>
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>    <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>  <span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<ul>
  <li>urlパラメータはRailsの_PATH表記から文字列に変更</li>
  <li>memo.idをview内のhiddenフィールドに保存して、jQueryでその値を取得するように変更</li>
  <li>Railsのフォームから呼ばれた場合とjQueryから呼ばれた場合でrenderするものを変更する</li>
</ul>

<p>　これで一応checkboxでの更新＆表示処理が完成しましたが、Railsで生成したフォームからupdateメソッドを呼び出す場合とjQueryからupdateメソッドを呼び出す場合で、画面出力処理が２種類（js.erbと.doneイベント）に分かれています。このサンプルの場合@status変数に格納した文字列を画面に表示するだけの処理ですが、それでも同じ処理をするコードが２ヶ所に存在しているのはよくないでしょう。Javascript側からAjax通信を開始（request.send、$.ajax）するときにコールバック関数としてjs.erbを指定することが出来たり（もしかして出来る？）、RailsのフォームからAjax通信するときにcoffeescript（Javascript、jQuery）のコールバック関数を指定出来たりしたら出力関数を統一出来そうですがそれはそれでややこしそうです。<br />
　あと、request.methodで分岐していますが、これでいいのかどうか分かりませんしこういうコードは見かけたことが無いような気がします。<br />
　ということで結局実際に使用するアプリではformから更新ボタンを無くしてjs.erbは使わないやり方に統一することにしました。こんなことになるなら最初からjs.erbは使わずにjQueryとCoffeeScriptで作ることに決めておけばよかったような気がします。<br />
　それと実際に使用するサイトでやりたかったことはlazy_high_chartsを使ったグラフ表示なのでdataTypeはtextでなくjsonでやりとりしています。とてつもなく<a href="https://github.com/happyclam/my-posi">汚いソース</a>ですが興味のある方はそちらで確認出来ます。</p>

<ul>
  <li>修正前（左）と修正後（右）</li>
</ul>

<div style="width:320px; height:240px; float: left;">
  <p><img src="/images/my-posi-update-old.png" alt="修正前グラフ編集画面" title="修正前グラフ編集画面" /></p>
</div>

<div style="width:20px; height:240px; float: left;"></div>

<div style="width:320px; height:240px; float: left;">
  <p><img src="/images/my-posi-update-new.png" alt="修正後グラフ編集画面" title="修正後グラフ編集画面" /></p>
</div>

<div style="width:320px; height:280px; margin: 0 auto;"></div>

<p>　注意点としてこのアプリの場合、編集画面と新規登録画面が別々なのでよかったのですが、説明に使用したサンプルプロジェクトでは編集画面と新規登録画面で同じフォームを利用しているので新規登録画面でcheckboxをクリックしたときはjQueryイベントが発動しないようにするかフォームを分ける必要があると思います。<br />
　そもそもcheckboxクリックで更新処理というのが特殊なUIなのかもしれませんが…。  </p>

<hr />

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>javascriptをcoffeescriptに書き換えるのは<a href="http://js2coffee.org/">こちらのサイト</a>を利用しました <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

    </div>

  
    <ul class="tag_box inline">
      <li><i class="icon-folder-open"></i></li>
      
      


  
     
    	<li><a href="/categories.html#programming-ref">
    		programming <span>9</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="icon-tags"></i></li>
      
      


  
     
    	<li><a href="/tags.html#rails-ref">rails <span>10</span></a></li>
     
    	<li><a href="/tags.html#my-posi-ref">my-posi <span>6</span></a></li>
     
    	<li><a href="/tags.html#jquery-ref">jquery <span>2</span></a></li>
     
    	<li><a href="/tags.html#coffeescript-ref">coffeescript <span>5</span></a></li>
    
  



    </ul>
    

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/programming/2014-11-05/sideci_review" title="自動でコードレビュー">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/programming/2015-01-25/ruby_to_js" title="Ruby製プログラムをCoffeeScript（JavaScript）に書き換える">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'happyclam'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>
      <hr>
      <footer>
        <p>&copy; 2015 happyclam
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div>

    
  </body>
</html>

