<!DOCTYPE html>
<html lang="ja">
  <head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=yes">
  <meta name="author" content="happyclam">
  <meta name="description"
    content="将棋＆チェスアプリの高速化 単なる悪あがきかもしれない Reinventing the wheel.">
  <title> 将棋＆チェスアプリの高速化 - 自己満足プログラミング </title>

  <!-- <\!-- Global Site Tag (gtag.js) - Google Analytics -\-> -->
  <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=UA-1752720-7"></script> -->
  <!-- <script> -->
  <!--   window.dataLayer = window.dataLayer || []; -->
  <!--   function gtag(){dataLayer.push(arguments);} -->
  <!--   gtag('js', new Date()); -->
  <!--   gtag('config', 'UA-1752720-7'); -->
  <!-- </script> -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DEV3LMTH6C"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DEV3LMTH6C');
</script>

  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@SappierBoy">
  <meta name="twitter:creator" content="@SappierBoy">
  
  <meta name="twitter:title" content="将棋＆チェスアプリの高速化">
  
  
  <meta name="twitter:url" content="/software/2025-10-12/ListOrArray">
  
  
  <meta name="twitter:description" content="もうデータ構造を小さくするしか無い？">
  
  
  <meta name="twitter:image:src" content="https://happyclam.github.io/images/33shogi_logo.png">
  

  <link rel="canonical" href="https://happyclam.github.io/software/2025-10-12/ListOrArray" />
  <link rel="alternate" type="application/rss+xml" title="自己満足プログラミング" href="/feed.xml" />
  <!-- stylesheets -->
  <link media="all" href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
  <link media="all" href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link media="all" rel="stylesheet" href="/assets/css/site.css">

</head>


<body>
  <header>
  <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a id="site-title" class="navbar-brand" href="/">
          <img class="pull-left img-responsive" src="">
          <span class="name-holder">自己満足プログラミング</span>
        </a>
      </div>

      <div class="collapse navbar-collapse" id="navbar">

        <ul id="main-menu" class="nav navbar-nav navbar-right">

          
            <li>
<a href="/">
              <i class="fa fa-home"></i> Home</a>
            </li>
          
            <li>
<a href="/categories/">
              <i class="fa fa-sitemap"></i> Categories</a>
            </li>
          
            <li>
<a href="/tags/">
              <i class="fa fa-tag"></i> Tags</a>
            </li>
          
            <li>
<a href="/about/">
              <i class="fa fa-info-circle"></i> About</a>
            </li>
          
            <li>
<a href="/policy/">
              <i class="fa fa-check"></i> Policy</a>
            </li>
          

        </ul>
      </div>
      <!-- /.navbar-collapse -->
    </div>
    <!-- /.container-fluid -->
  </nav>
</header>

  <script src="/assets/js/simple-jekyll-search.min.js"></script>
<!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1238485061299241" -->
<!--      crossorigin="anonymous"></script> -->

  <div class="blog-header">
    <div class="row-fluid">
      <div class="span3">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="SappierBoy">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
      </div>
      <div class="span9">
        <!-- Html Elements for Search -->
        <div id="search-container" align="right">
          <input type="text" id="search-input" placeholder="search...">
          <ul class="searchresult" id="results-container"></ul>
        </div>
        <div class="results"></div>
      </div>
    </div>
<script type="text/javascript">
  SimpleJekyllSearch.init({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('results-container'),
    json: '/search.json',
    searchResultTemplate: '<li><a href="{url}" title="{category}:{title}">{title}</a></li>',
    noResultsText: 'No results found',
    limit: 15,
    fuzzy: false,
  })
</script>
  <script src="/assets/js/jquery.min.js"></script>
  </div>
  <div class="container">
  <div class="row">
    <div class="col-xs-12 col-sm-12 col-md-offset-1 col-md-10 col-lg-offset-2 col-lg-8">
      <div class="page">

        <header class="page-header">
          <h2 class="page-title"><a href="/software/2025-10-12/ListOrArray">将棋＆チェスアプリの高速化</a></h2>
          <div class="post-metadata">
            <div> <i class="fa fa-calendar"></i>
              <time>
                Sunday, October 12, 2025
              </time>
            </div>
            <div> <i class="fa fa-tag"></i>
                
                  <span class="label label-tag">coffeescript</span>
                
                  <span class="label label-tag">javascript</span>
                
                  <span class="label label-tag">shogi</span>
                
                  <span class="label label-tag">c++</span>
                
            </div>
          </div>

        </header>

        <article class="page-content">
          <h3 id="効果は微々たるもの">効果は微々たるもの</h3>
<p>　<a href="/software/2025-08-23/JSvsCPlus">前回の記事</a>で書いたChatGPTからのアドバイス（駒種判定のためのメソッド呼び出しをやめた件）をCoffeeScript(JavaScript)版にも取り入れて少しは速度アップ（README.mdの例で<code class="language-plaintext highlighter-rouge">1781ミリ秒</code>掛かっていた処理が<code class="language-plaintext highlighter-rouge">1279ミリ秒</code>、約25%アップ）しましたが体感できるほどではありません（<a href="https://github.com/happyclam/shogi33simple">masterのlistPiecesタグ</a>）。<br>
　そこで、その最新バージョンを元に将棋盤を配列として扱う形に変更して、Pieceオブジェクトで座標管理するのをやめてみました（<a href="https://github.com/happyclam/shogi33simple/tree/arrayBoard">arrayBoardブランチ</a>）。そして、取り敢えず速度の比較が出来るところまで作り込んだだけで全然未完成なのですが、取り敢えず気になっていたことを確認してみました。</p>

<h3 id="何が気になっていたのか">何が気になっていたのか</h3>
<p>　現行のプログラムでは将棋盤オブジェクト(Board)で全ての駒オブジェクト(Piece)のリストを管理していて、盤上の座標位置は駒オブジェクトに持たせています。普通に考えれば将棋盤クラスで座標（段・列）を管理することを考えると思いますが、駒台が必要なので駒台にある駒と将棋盤上にある駒を区別して管理するのが面倒です。作ったのはかなり昔なのでその時の動機をはっきりと憶えているわけではありませんが、着手した手を元に戻す操作を実装する際に、持ち駒を打ったのか盤上の駒を動かしたのかによって処理が分かれるので、局面を読み進める際に「指しては戻し、打っては戻し、取った相手の駒を駒台から盤上に戻す、という操作を繰り返しながら整合性を保つのは大変だ、絶対バグる」と考えたのだと思います。Pieceオブジェクトで座標を管理していれば、持ち駒も盤上の駒も区別なくPieceオブジェクトが持つ座標を書き換えるだけで済むというメリットがあります。<br>
　<a href="/software/2023-11-18/abmethod_skipped">マンカラアプリの解説記事</a>でも書いていますが、マンカラで着手した一手を元に戻すのは「横取り」のルール等もあって非常にややこしいので、マンカラの先読み過程では一手毎にマンカラの盤ごとコピーして、着手して局面を評価した後に破棄するというやり方で実装しました。着手を元に戻すという処理をしていません。マンカラの場合は豆の数が入った単なる一つの配列なのでコピーしても負荷は小さいですが、将棋盤オブジェクトとそこにある駒オブジェクトの局面ごとコピーするのはかなりの負荷なので、将棋プログラムでマンカラと同じやり方で実装すると実行速度アップは望めません。<br>
　なので、マンカラほど複雑ではないとはいえ、頑張って着手を元に戻す処理（<code class="language-plaintext highlighter-rouge">revert処理</code>）さえ正確に実装すれば将棋盤と駒台が分かれていても速度アップできるのかな？と考えてそれを確かめるために<a href="https://github.com/happyclam/shogi33simple/tree/arrayBoard">arrayBoard</a>ブランチを作って試してみたわけです。<br>
　<a href="/software/2025-08-23/JSvsCPlus">前回の記事</a>で「<code class="language-plaintext highlighter-rouge">ChatGPT</code>が将棋盤を配列にしろ」と言ってましたが、<code class="language-plaintext highlighter-rouge">Grok</code>に聞いても同じアドバイスをされました。どうやら生成AIにとっては「これが正解」という将棋プログラムの<code class="language-plaintext highlighter-rouge">クラス設計</code>がはっきりしているということかもしれません。速くなるのなら独自のやり方に拘るつもりもないので、将来的には<code class="language-plaintext highlighter-rouge">Grok</code>が示すやり方で仕上げてみようかとも思ってます。</p>

<h3 id="具体的な変更箇所">具体的な変更箇所</h3>
<p>　やったことを簡単に言えばPieceクラスから座標を管理するための<code class="language-plaintext highlighter-rouge">@posiメンバー</code>を削除して、Boardクラスを配列クラスの継承クラスにしただけなのですが、これをすることによって</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dest = (v for v in @pieces when v.posi? &amp;&amp; v.posi[0] == d_posi[0] &amp;&amp; v.
posi[1] == d_posi[1])[0]
</code></pre></div></div>

<p>このように全ての駒を走査してその場所に存在する駒を取得していた処理が</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dest = @[d_posi[0] - 1][d_posi[1] - 1]
</code></pre></div></div>

<p>とBoardオブジェクトの配列を参照する処理だけで済みます。<br>
現在リリースしているアプリも今回の改良版（<a href="https://github.com/happyclam/shogi33simple">master</a>）でも、最も頻繁に呼び出されるであろう着手可能かどうかを判定するメソッド（<code class="language-plaintext highlighter-rouge">check_move</code>）内でこの作業を毎回やっていて、流石にこれは冗長だろうと考えてPlayer.think内ではわざわざ盤面用の２元配列を用意して（Player.think内のsrc変数）Pieceオブジェクトをその配列に配置し直して駒のリストを全探索しないで済むように改良した経緯があります。<br>
　そんなこと（駒オブジェクトで管理している座標を元に将棋盤の配列を生成）しているぐらいなら、元からBoardクラスを配列にしていた方が速くなるのかな？と考えて今回実験してみたのですが、結果は？</p>

<h3 id="arrayboardブランチの実験結果">arrayBoardブランチの実験結果</h3>
<p>　README.mdの対局例を実行した結果は<code class="language-plaintext highlighter-rouge">1700ミリ秒</code>ぐらいかかって、現在リリースしているバージョンとほぼ変わりませんでした。現在リリース中のアプリより若干改良高速化した後での結果ですから、Boardクラスを配列にしただけでは却って遅くなったと言えます。結局、将棋盤上の駒を取得する処理が軽くなっても指し手の<code class="language-plaintext highlighter-rouge">revert処理</code>は複雑になってしまいましたし、トレードオフの関係にあるのでしょう。<br>
　とはいえBoardクラスを配列にすると他にも高速化の手法がありそうなので今後も<code class="language-plaintext highlighter-rouge">arrayBoardブランチ</code>を育てていくかもしれませんが、取り敢えずはここで打ち切ろうと思ってます。<br>
　それと今回やった作業は駒の数が少ない３三将棋だから効果が薄かったのかもしれませんので、７七将棋でも試したいと思ってますが、現状の<code class="language-plaintext highlighter-rouge">arrayBoardブランチ</code>はまだまだやり足りないことがいっぱいなので、完成するのはかなり先の話になると思います。<br>
　そして完成したからといって速くなってる保証もありません<img class="emoji" title=":sweat_smile:" alt=":sweat_smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png" height="20" width="20">ただ、そのソースを元に<code class="language-plaintext highlighter-rouge">C++</code>に書き換えたら<a href="/software/2025-08-23/JSvsCPlus">前回の記事</a>の結果とは違って速くなる、なんてことになるような気がします。</p>

<h3 id="今後のアプリの予定">今後のアプリの予定</h3>
<p>　冒頭で書いたように現在リリースしているものより若干は速くなったので<a href="https://github.com/happyclam/shogi33simple">master（listPiecesタグ）</a>の内容を反映して、将棋アプリもチェスアプリも順次リリースしていこうと思ってます。ついでに、最近はハイスペックなスマホも増えているので、どうせならAIのレベルを一手づつ読む深さを深くしてリリースしてみたいと思っているのですが、そうすると最強レベルだと現在以上に指し手が遅くなりますので、アプリを使う気が無くなるぐらい遅くなるかもしれません。でも、AIのレベルを下げれば今まで通りの指し手になるわけですから、あってもいいんじゃないかと思ってます。 全然ハイスペックではありませんが、私自身つい先日スマホを買い替えた（<code class="language-plaintext highlighter-rouge">Pixel10Ⅶ</code>）ので、それで試してから決めようと思ってます。一手深く読めば指し手がどのように変わるのか楽しみですよね？私は楽しみです<img class="emoji" title=":smile:" alt=":smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png" height="20" width="20"><br>
　いずれにしても<a href="https://happyclam.booth.pm/">私のアプリ</a>を使う人は指し手を気長に待てる人にしか向いてないと思います。</p>

<h3 id="よく分からない2025-10-15追記">よく分からない（2025-10-15追記）</h3>
<p>　<a href="https://github.com/happyclam/shogi33simple/tree/arrayBoard">arrayBoardブランチ</a>がバグってて、<a href="https://github.com/happyclam/shogi33simple">master（listPiecesタグ）</a>より遅いのはそのままですが、バグを修正したら差が縮まってほぼ違いがないぐらいになりました（<code class="language-plaintext highlighter-rouge">1338ミリ秒</code>、arrayBoardブランチは修正済み）。それならと、７七将棋アプリで同じことを試してみたら<code class="language-plaintext highlighter-rouge">配列バージョン</code>よりやはり<code class="language-plaintext highlighter-rouge">駒リストバージョン</code>のほうが速かったです。う〜ん、成功する（させることが出来る）テスト自体まだ少ないのですが、将棋の駒が多い分効果が出るかと思ったのですが、よく分かりません。いつも開発作業を進めながら記事を書くことが多くて、早合点が多くて良くないですね。いずれにしても、もう少し突き詰めてから結論出そうと思います。<br>
　と、いうことで新バージョンのリリースはもう少し後にしようと思います。</p>

<h3 id="７七将棋なら効果あり2025-10-25追記">７七将棋なら効果あり（2025-10-25追記）</h3>
<p>　３三将棋と同じところまで７七将棋の<code class="language-plaintext highlighter-rouge">配列バージョン</code>の対応を済ませてテストスクリプトの実行時間を確認したところ、３三将棋とは違って明確に速くなっているので取り敢えず７七将棋だけ<code class="language-plaintext highlighter-rouge">配列バージョン</code>に変更してリリースしてみようと思います。<br>
　<a href="https://github.com/happyclam/shogi33simple">３三将棋</a>でも一部のテスト結果が旧版の<code class="language-plaintext highlighter-rouge">駒リストバージョン</code>とは違う結果（テスト失敗）になっていますが、７七将棋でも指し手に変化が出るようです。局面の静的評価に関わる数値は一切変更していないのに、指し手に変化が出る理由がはっきり分からないのですが、読む深さを変えるとテスト結果を旧版と同じにすることが可能なケースがほとんどなので今のところ大きな問題はないと思ってます。<br>
　また、劇的に速くなったわけではないので、読みの深さを一手深くするのは今回は見送ります。読みの深さを変えなくても指し手が変わるので、それをしばらく楽しんでみようというのが本音です。<code class="language-plaintext highlighter-rouge">「Done is better than perfect」</code>なんて言いますし…<img class="emoji" title=":sweat_smile:" alt=":sweat_smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png" height="20" width="20"></p>

<hr>


        </article>
      </div>
    </div>
  </div>
</div>


  

<footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-lg-offset-3 col-lg-6">
        <div class="row">
          <div class="col-xs-12 text-center">
            <small>© rifyll theme, 2014</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>


  <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> -->
  <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script> -->
  <script src="/assets/js/bootstrap.min.js"></script>

  <!--<script src="/assets/js/prism.js"></script> -->
  <script src="/assets/js/site.js"></script>
</body>

</html>
